# 任务管理组件

本目录包含了任务管理相关的前端组件，用于显示和管理测试任务。

## 页面设计

### 队列页面 (`/model-testing/queue`)
**设计理念：** 时间线展示，从新到旧排序，全屏宽度布局

**功能特性：**
- 显示所有正在执行（processing）和排队（pending）的任务
- 时间线布局，按创建时间排序（最新在前）
- 实时显示任务进度和执行时间
- 自动刷新（3秒间隔）
- 任务状态动画效果（执行中任务有脉冲动画）
- 响应式卡片布局，全屏宽度显示
- 优化的间距和字体大小

**显示信息：**
- 任务名称和状态（支持processing状态）
- 用户名和创建时间
- 执行时长（实时计算）
- 进度条和图片处理数量
- 任务ID（简化显示）

### 历史页面 (`/model-testing/history`)
**设计理念：** 卡片网格展示，支持全屏显示，响应式布局

**功能特性：**
- 竖版卡片网格布局（1-5列自适应）
- 显示总量、成功数量、失败数量统计
- 支持状态、用户名、任务名搜索筛选
- 分页显示（每页20个）
- 响应式布局，全屏宽度
- 悬停效果和交互反馈
- 优化的卡片间距

**显示信息：**
- 任务名称（支持长文本截断）
- 任务状态和完成时间
- 用户名和创建时间
- 任务执行时长
- 图片处理数量
- 任务ID

## 状态映射修复

**重要更新：** 修复了前后端状态不一致的问题
- 后端使用 `"processing"` 状态表示正在执行的任务
- 前端已更新支持 `"processing"` 状态
- TaskStatusChip组件已支持processing状态显示
- 类型定义已添加PROCESSING枚举

## 布局优化

### 主要修复
**重要更新：** 修复了页面布局过窄的问题
- 移除了主布局容器的内边距限制（`app-sidebar-layout.tsx`）
- 在页面组件中添加适当的内边距（`p-6`）
- 实现了在剩余空间中居中显示，最大宽度为4xl

### 队列页面优化
- 移除容器宽度限制，使用全屏宽度
- 在剩余空间中居中显示（`flex justify-center`）
- 最大宽度限制为4xl（`max-w-4xl`）
- 增加卡片内边距（p-4 → p-6）
- 增加元素间距（gap-4 → gap-6）
- 增大任务名称字体（text-lg → text-xl）
- 增大进度百分比字体
- 增大进度条尺寸（size-sm → size-md）

### 历史页面优化
- 移除容器宽度限制，使用全屏宽度
- 在剩余空间中居中显示（`flex justify-center`）
- 最大宽度限制为4xl（`max-w-4xl`）
- 增加网格间距（gap-4 → gap-6）
- 添加2xl断点支持（最大5列显示）
- 确保所有卡片和容器使用全宽
- 优化卡片高度适配（h-fit）

### 布局结构
```tsx
// 新的布局结构
<div className="flex justify-center w-full p-6">
  <div className="w-full max-w-4xl space-y-6">
    {/* 页面内容 */}
  </div>
</div>
```

## 组件列表

### TaskStatusChip
任务状态显示组件，用于显示不同状态的任务标签。

**功能特性：**
- 支持多种任务状态（等待中、运行中、处理中、已完成、失败、已取消）
- 使用不同颜色和图标区分状态
- 支持不同尺寸
- **新增：** 支持processing状态

### TaskProgressBar
任务进度条组件，显示任务的完成进度。

**功能特性：**
- 显示任务进度百分比
- 显示已处理/总图片数量
- 根据进度自动调整颜色
- 支持显示/隐藏标签

### TaskList (已弃用)
原任务列表组件，已被新的页面设计替代。

## 使用方式

### 队列页面
```tsx
// 直接访问 /model-testing/queue
// 自动显示运行中(processing)和排队(pending)的任务
// 支持实时刷新和时间线展示
// 全屏宽度布局，优化的视觉效果
```

### 历史页面
```tsx
// 直接访问 /model-testing/history
// 显示已完成任务的卡片网格
// 支持多种筛选和搜索功能
// 响应式网格布局（1-5列）
```

## 搜索和筛选功能

历史页面支持多种筛选方式：

1. **状态筛选**: 按任务状态筛选（已完成、失败、已取消）
2. **用户筛选**: 按用户名筛选任务
3. **任务名搜索**: 支持任务名的部分匹配搜索
4. **组合筛选**: 可同时使用多种筛选条件
5. **筛选可视化**: 当前筛选条件以标签形式显示
6. **快速清除**: 一键清除所有筛选条件

## API 集成

页面通过 `@/utils/apiClient` 与后端API通信，支持以下接口：

- `getTasks(page, pageSize, status, username, taskName)` - 获取任务列表（支持搜索）
- `getTask()` - 获取任务详情
- `cancelTask()` - 取消任务
- `getRunningTasks()` - 获取运行中任务

**状态映射：**
- 前端查询 `"processing"` 状态获取正在执行的任务
- 前端查询 `"pending"` 状态获取排队中的任务

## 类型定义

所有相关类型定义位于 `@/types/task.ts`，包括：

- `TaskListItem` - 任务列表项
- `TaskDetailResponse` - 任务详情
- `TaskStatus` - 任务状态枚举（包含PROCESSING）
- `APIResponse` - API响应包装

## 刷新机制

- **队列页面**: 3秒自动刷新，实时更新任务状态
- **历史页面**: 手动刷新，支持统计数据更新

## 响应式设计

### 队列页面
- 时间线布局适配移动端
- 卡片信息自动调整显示密度
- 支持触摸滚动
- 全屏宽度布局

### 历史页面
- 网格布局自适应：
  - 手机：1列
  - 平板：2列
  - 桌面：3列
  - 大屏：4列
  - 超大屏：5列
- 卡片内容响应式调整
- 全屏宽度布局

## 后端API更新

后端 `/api/v1/test/tasks` 接口已支持以下查询参数：
- `page`: 页码
- `page_size`: 每页大小
- `status`: 任务状态过滤（支持processing状态）
- `username`: 用户名过滤
- `task_name`: 任务名搜索（部分匹配）

## 性能优化

1. **分页加载**: 避免一次性加载大量数据
2. **虚拟滚动**: 队列页面支持大量任务显示
3. **智能刷新**: 只在必要时更新数据
4. **缓存策略**: 合理使用本地状态缓存
5. **懒加载**: 图片和非关键内容延迟加载

## 故障排除

### 执行中任务不显示
- **问题**: 前端查询"running"状态，但后端使用"processing"状态
- **解决**: 已修复状态映射，前端现在正确查询"processing"状态

### 页面布局太窄
- **问题**: 容器有最大宽度限制
- **解决**: 已移除宽度限制，使用全屏宽度布局

## 最新优化 (v2.0)

### UI样式统一
- **标题样式**: 队列和历史页面标题样式统一为 `text-xl font-medium mb-4 pt-2 pb-4`，与测试页面保持一致
- **复制按钮位置**: 任务ID复制按钮调整到ID末尾，使用更小的尺寸 (`h-5 w-5`)
- **紧凑布局**: 进一步优化任务卡片间距和元素尺寸

### 路由优化
- **主页设置**: 测试页面 (`/model-testing/test`) 设为模型测试工作区的主页
- **自动跳转**: 访问 `/model-testing` 时自动跳转到测试页面
- **双重保障**: 在布局组件和根路径页面都设置了跳转逻辑

### 队列页面优化 (v2.0)
- 标题样式与测试页面统一
- 任务卡片高度进一步减小
- 复制按钮紧跟在任务ID末尾
- 完整显示任务ID，方便复制和识别
- 优化时间线连接线位置

### 历史页面优化 (v2.0)
- 标题样式与测试页面统一
- 保持卡片网格布局的响应式设计
- 统计信息显示优化